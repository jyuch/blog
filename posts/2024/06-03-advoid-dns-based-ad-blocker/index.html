<!doctype html><html lang=ja><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>RustでもDNSベースのアドブロッカーを実装したい - レンコン畑でつかまえて</title><meta content=Rustで実装したアドブロッカーの紹介です name=description><link href=/pagefind/pagefind-ui.css rel=stylesheet><link href=/styles.css rel=stylesheet><link href=/feed.xml rel=alternate title=レンコン畑でつかまえて type=application/atom+xml><link href=/feed.json rel=alternate title=レンコン畑でつかまえて type=application/json><script src=/pagefind/pagefind-ui.js></script><script>window.addEventListener('DOMContentLoaded',()=>{new PagefindUI({"element":"#search","showImages":false,"excerptLength":0,"showEmptyFilters":true,"showSubResults":false,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"});});</script><body><nav class=navbar><a class=navbar-home href=/> <strong>レンコン畑でつかまえて</strong> </a><ul class=navbar-links><li><a href=/> Home </a><li><a href=/posts/> Archive </a><li><a href=https://about.jyuch.dev/> About Me </a></ul><div class=navbar-search><div id=search></div></div></nav><main class=body-post><article class=post data-pagefind-body><div class=post-header><h1 class=post-title>RustでもDNSベースのアドブロッカーを実装したい</h1><nav class=post-tags><a class=tag href=/tags/rust/>rust</a><a class=tag href=/tags/dns/>dns</a></nav><time datetime="2024-06-03 00:00:00" class=post-date> June 3rd, 2024 </time></div><div class=post-body><h1>はじめに</h1><p>最近は履歴に介入したり勝手に全画面表示してくるｱﾚなWeb広告が増えてきましたよね。<p>というのは特に関係なく、なんとなく手持ちの知識で作れそうなのでアドブロッカーを自作しました。<p><a href=https://github.com/jyuch/advoid>advoid - DNS based AD blocker</a><h1>動作原理</h1><p>基本的な原理はフルリゾルバのクライアントの間に挟まり、広告を配信しているドメインのクエリをインターセプトして<code>NXDOMAIN</code>を返すというよくあるものです。 ですので、基本的には配下の端末全体で広告をブロック出来るようになります。<p>あくまでも上位のフルリゾルバへのクエリをフィルタリングしているだけなので、advoid自体にはキャッシュは持っていません。<p>また、正規の実装であれば<code>NXDOMAIN</code>を返すときはネガティブキャッシュをさせるためにSOAレコードも返すべきです。 しかし、フィルタリング自体はadvoidの内部で行っており、ブロック対象のレコードに対してはμsオーダーでレスポンスを返せているためわざわざSOAを上位のフルリゾルバに問い合わせるよりも空で返したほうが速いと思って返していません。<h1>実装コンセプト</h1><p>手軽に使えるようにバイナリのポン置きとブロックするドメインの定義ファイルだけで動作するようになっています。<p>実装には最近お気に入りのRustを使用しており、クエリの待ち受けやフルリゾルバへクエリをフォワーディングするのには<a href=https://github.com/hickory-dns/hickory-dns>hickory-dns</a>を利用しています。<p>また、どれだけのリクエストを受け取ってどれだけブロックしたか確認できるようにPrometheusのexporterを生やしています。 まぁ、カウンタは今のところ3つしかありませんが。<pre><code class="language-text hljs language-plaintext"># TYPE dns_requests_total counter
dns_requests_total 4149

# TYPE dns_requests_block counter
dns_requests_block 3583

# TYPE dns_requests_forward counter
dns_requests_forward 566
</code></pre><p>また、デバッグしているときに欲しかったのでOpenTelemetryでテレメトリを採れるようにしてあります。Jaegerとセットでどうぞ<h1>おわりに</h1><p>とりあえず単純なフォワーディングとフィルタリングは出来るようになったのですが、TCPフォールバックとかActive Directory配下のDynamic DNSの透過とかはまだなので追い追い実装していきます。<p>おわり</div></article><hr><nav class=post-navigation><ul><li>← Previous: <a href=/posts/2024/04-01-dns-forwarder-using-hickory-dns/ rel=prev>RustでもHickory DNSを使ってDNS Forwarderを実装したい</a><li><strong>Next: <a href=/posts/2024/07-09-pyenv/ rel=next>Windowsでもpyenvを使いたい</a> →</strong></ul></nav></main><footer><div><a href=/feed.xml> <svg viewbox="0 0 16 16" height=16 width=16 xmlns=http://www.w3.org/2000/svg><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"></path><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"></path></svg> </a></div></footer>