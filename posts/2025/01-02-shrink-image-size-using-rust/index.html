<!doctype html><html lang=ja><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>RustでもAVIFフォーマットに変換して画像サイズを縮小したい - レンコン畑でつかまえて</title><meta content=Rustとimage-rsを使用して画像をavifフォーマットに変換する方法を紹介します。 name=description><link href=/pagefind/pagefind-ui.css rel=stylesheet><link href=/styles.css rel=stylesheet><link href=/feed.xml rel=alternate title=レンコン畑でつかまえて type=application/atom+xml><link href=/feed.json rel=alternate title=レンコン畑でつかまえて type=application/json><script src=/pagefind/pagefind-ui.js></script><script>window.addEventListener('DOMContentLoaded',()=>{new PagefindUI({"element":"#search","showImages":false,"excerptLength":0,"showEmptyFilters":true,"showSubResults":false,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"});});</script><body><nav class=navbar><a class=navbar-home href=/> <strong>レンコン畑でつかまえて</strong> </a><ul class=navbar-links><li><a href=/> Home </a><li><a href=/posts/> Archive </a><li><a href=https://about.jyuch.dev/> About Me </a></ul><div class=navbar-search><div id=search></div></div></nav><main class=body-post><article class=post data-pagefind-body><div class=post-header><h1 class=post-title>RustでもAVIFフォーマットに変換して画像サイズを縮小したい</h1><nav class=post-tags><a class=tag href=/tags/rust/>rust</a></nav><time datetime="2025-01-02 00:00:00" class=post-date> January 2nd, 2025 </time></div><div class=post-body><h1>はじめに</h1><p>Rustとimage-rsを使ってjpeg画像などをAVIFフォーマットに変換して画像サイズを縮小するツールを作成したのでそれについてです。<p><a href=https://github.com/jyuch/cwebp>cwebp</a><p>自炊したスキャン画像があり、普段はPCで参照していたのでWindows標準の画像ビューワで見ていました。 しかし、諸般の事情で手元のiPhoneでも見れたほうがいいよねってことで画像ファイルを本ごとにブラウザで見れるようにSSGを使ってHTMLに起こしました。<p>宅内からでしか参照しないのでオリジナルサイズの画像をそのまま貼り付けても良かったのですが、画像数が32000程度あり取り回しやサーバへの転送でつらみポイントが高めだったので、ナウでヤングなファイルフォーマットを使って取り回しを良くしたいというのが作った動機です。<p>また、単純に画像を変換するだけならImageMagicを使えば良いと思いますが、画像を保存しているディレクトリ構造を保ったまま一括で変換してほしかったのでツールを作成しました。<p>最初はWebPフォーマットにしようとしましたが、ビット深度を落としてもオリジナルサイズの2倍くらいのサイズになってしまうのでAVIFフォーマットに切り替えたという経緯があります。<h1>使用ライブラリ</h1><p>Rustでの画像操作ライブラリは<a href=https://github.com/image-rs/image>image-rs</a>を使っています。<p>オリジナルファイルは残す前提なので、ファイルサイズを縮小することを優先して変換を掛けています。<p>書籍系の画像なのでアルファチャネルは不要で、カラーはRGBでビット深度が24bit、モノクロははビット深度を8bitに落としています。<p>image-rsは書き出し時に指定するパスのファイルの拡張子からフォーマットを決めてくれるので、出力パスを決定する段階で拡張子<code>.avif</code>を付けています。<p>また、これは完全に私の管理が悪いのですが、たまに拡張子とファイルフォーマットが一致していないファイルがあったりします。 そのため、画像を読み込むときは拡張子から読み込むフォーマットを決めているのではなく、ファイルから読み込んだ中身からファイルフォーマットを類推させています。<p>あとは、画像サイズをコマンドラインパラメータから指定できるようにし、画像サイズの縮小も同時に行っています。<pre><code class="language-rs hljs language-rust"><span class=hljs-keyword>fn</span> <span class="hljs-title function_">convert</span>(
    input: <span class=hljs-keyword>impl</span> <span class="hljs-title class_">AsRef</span>&lt;Path>,
    output: <span class=hljs-keyword>impl</span> <span class="hljs-title class_">AsRef</span>&lt;Path>,
    width: <span class=hljs-type>Option</span>&lt;<span class=hljs-type>u32</span>>,
    height: <span class=hljs-type>Option</span>&lt;<span class=hljs-type>u32</span>>,
) <span class=hljs-punctuation>-></span> anyhow::<span class=hljs-type>Result</span>&lt;()> {
    <span class=hljs-keyword>let</span> <span class=hljs-variable>content</span> = fs::<span class="hljs-title function_ invoke__">read</span>(&input)?;
    <span class=hljs-keyword>let</span> <span class=hljs-variable>img</span> = ImageReader::<span class="hljs-title function_ invoke__">new</span>(Cursor::<span class="hljs-title function_ invoke__">new</span>(&content))
        .<span class="hljs-title function_ invoke__">with_guessed_format</span>()?
        .<span class="hljs-title function_ invoke__">decode</span>()?;

    <span class=hljs-keyword>let</span> (cur_width, cur_height) = img.<span class="hljs-title function_ invoke__">dimensions</span>();
    <span class=hljs-keyword>let</span> <span class=hljs-variable>new_width</span> = width.<span class="hljs-title function_ invoke__">unwrap_or</span>(cur_width);
    <span class=hljs-keyword>let</span> <span class=hljs-variable>new_height</span> = height.<span class="hljs-title function_ invoke__">unwrap_or</span>(cur_height);
    <span class=hljs-keyword>let</span> <span class=hljs-variable>img</span> = img.<span class="hljs-title function_ invoke__">resize</span>(new_width, new_height, FilterType::Lanczos3);

    <span class=hljs-keyword>let</span> <span class=hljs-variable>img</span>: DynamicImage = <span class=hljs-keyword>match</span> img.<span class="hljs-title function_ invoke__">color</span>() {
        ColorType::L8 | ColorType::La8 | ColorType::L16 | ColorType::La16 => {
            DynamicImage::<span class="hljs-title function_ invoke__">from</span>(img.<span class="hljs-title function_ invoke__">into_luma8</span>())
        }
        ColorType::Rgb8
        | ColorType::Rgba8
        | ColorType::Rgb16
        | ColorType::Rgba16
        | ColorType::Rgb32F
        | ColorType::Rgba32F => DynamicImage::<span class="hljs-title function_ invoke__">from</span>(img.<span class="hljs-title function_ invoke__">into_rgb8</span>()),
        _ => <span class=hljs-built_in>unreachable!</span>(),
    };

    img.<span class="hljs-title function_ invoke__">save</span>(output)?;
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre><h1>縮小比と処理時間</h1><p>AVIFフォーマットの画像縮小は効果てきめんで、カラーならオリジナル比で40%、モノクロで60%くらいまで縮んでくれます。<p>ただし、処理時間がWebPフォーマットなどの比べるととても遅く、1ファイル当たり平均で811msくらい掛かります。 PNGなどが大体14mくらいなので、まぁ、うん、その、ねぇ・・・<p>おわり</div></article><hr><nav class=post-navigation><ul><li>← Previous: <a href=/posts/2024/12-31-look-back-2024/ rel=prev>2024年の振り返りとか</a><li><strong>Next: <a href=/posts/2025/01-19-determine-color-or-monochrome/ rel=next>Rustでも画像がカラーかモノクロか判別したい</a> →</strong></ul></nav></main><footer><div><a href=/feed.xml> <svg viewbox="0 0 16 16" height=16 width=16 xmlns=http://www.w3.org/2000/svg><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"></path><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"></path></svg> </a></div></footer>